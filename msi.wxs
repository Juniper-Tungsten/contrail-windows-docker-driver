<?xml version="1.0"?>
<!--
    msi.wxs

    Copyright (c) 2017 Juniper Networks, Inc. All rights reserved.
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="47DD6748-F596-4E97-A087-C9C386466C5F" UpgradeCode="730039F2-F0CE-46D2-90AB-746B97969FF8" Name="Contrail CNM Plugin" Version="1.0.0" Manufacturer="Juniper Networks" Language="1033">
        <Package InstallerVersion="200" Compressed="yes" Comments="Windows Installer Package" Platform="x64"/>
        <Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFiles64Folder">
                <Directory Id="ManufacturerFolder" Name="Juniper Networks">
                    <Directory Id="INSTALLDIR" Name="cnm-plugin">
                        <Component Id="CnmPluginFiles" Guid="C6721F37-871E-400D-A82C-DADEDD7661DD" Win64="yes">
                            <File Id="CnmPlugin" Source="build/contrail-cnm-plugin.exe"/>
                        </Component>
                        <Component Id="ContrailAutostartScriptFiles" Guid="849F20B3-F3A5-4344-A1C4-DE24C3B1A468" Win64="yes">
                            <File Id="ContrailAutostartScript" Source="Scripts/contrail-autostart.ps1"/>
                        </Component>
                    </Directory>
                </Directory>
            </Directory>
        </Directory>

        <Feature Id="DefaultFeature" Level="1">
            <ComponentRef Id="CnmPluginFiles"/>
            <ComponentRef Id="ContrailAutostartScriptFiles"/>
        </Feature>

        <CustomAction Id="ContrailAutostartCreateTask"
            Property="ContrailAutostartCreateTaskProperty"
            Execute="immediate"
            Value="&quot;C:\Windows\System32\schtasks.exe&quot; /Create /F /TN contrail-autostart /SC ONSTART /RU SYSTEM /TR &quot;powershell.exe -File &apos;[INSTALLDIR]contrail-autostart.ps1&apos;&quot;"/>

        <CustomAction Id="ContrailAutostartCreateTaskProperty"
            BinaryKey="WixCA"
            DllEntry="WixQuietExec64"
            Execute="deferred"
            Return="check"
            Impersonate="no"/>

        <CustomAction Id="ContrailAutostartDeleteTask"
            Property="ContrailAutostartDeleteTaskProperty"
            Execute="immediate"
            Value="&quot;C:\Windows\System32\schtasks.exe&quot; /Delete /F /TN contrail-autostart"/>

        <CustomAction Id="ContrailAutostartDeleteTaskProperty"
            BinaryKey="WixCA"
            DllEntry="WixQuietExec64"
            Execute="deferred"
            Return="check"
            Impersonate="no"/>

        <InstallExecuteSequence>
            <Custom Action="ContrailAutostartCreateTask" After="CostFinalize">NOT Installed</Custom>
            <Custom Action="ContrailAutostartCreateTaskProperty" After="InstallFiles">NOT Installed</Custom>
            <Custom Action='ContrailAutostartDeleteTask' Before='CostInitialize'>(NOT UPGRADINGPRODUCTCODE) AND (REMOVE="ALL")</Custom>
            <Custom Action='ContrailAutostartDeleteTaskProperty' Before='RemoveFiles'>(NOT UPGRADINGPRODUCTCODE) AND (REMOVE="ALL")</Custom>
        </InstallExecuteSequence>
    </Product>
</Wix>
